(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{471:function(s,a,t){"use strict";t.r(a);var n=t(2),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"一次k8s容器内存oom-kill问题研究"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一次k8s容器内存oom-kill问题研究"}},[s._v("#")]),s._v(" 一次k8s容器内存oom-kill问题研究")]),s._v(" "),a("h2",{attrs:{id:"问题现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题现象"}},[s._v("#")]),s._v(" 问题现象")]),s._v(" "),a("p",[s._v("公司最近逐步推进JRE8升级到JRE17，在解决了升级初期的一些库升级、兼容问题后，大部分应用容器趋于稳定。\n随着升级的服务越来越多，最近发现部分升级JRE17服务的容器有零星的注册中心健康检查失败报错，涉及到多个服务的多个节点，虽然在"),a("strong",[s._v("报错一次后恢复正常")]),s._v("，但是这个现象是以前这些服务从来没有出现过的，基于不放过任何一个疑点的原则，有必要调查一下原因。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2025")]),s._v("-05-28 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":01:28.330\n标题:断开连接"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("异常"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n应用:xxx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default:-1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n实例:10.100.1.1:8080\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"初步定位"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初步定位"}},[s._v("#")]),s._v(" 初步定位")]),s._v(" "),a("ol",[a("li",[s._v("最初的报错是注册中心发出，查看注册中心的事件日志确认，报错是因为注册中心调用容器的"),a("code",[s._v("/actuator/health")]),s._v("接口时，http连接异常断开")]),s._v(" "),a("li",[s._v("一般来说，http连接异常断开有几种可能\n"),a("ul",[a("li",[s._v("网络异常：丢包，延迟，阻塞")]),s._v(" "),a("li",[s._v("调用方超时主动断开：连接超时、读超时")]),s._v(" "),a("li",[s._v("被调用方响应性能异常：建连失败、响应超时、tcp reset")])])]),s._v(" "),a("li",[s._v("排查异常容器的核心指标，主要是worker线程数量，内网指标tcp丢包率等，排除了上述常见可能性后，再查看容器的事件日志，发现问题容器都有被k8s重启的相关事件，且时间点与注册中心异常告警一致，初步认定"),a("strong",[s._v("容器被k8s重启是导致注册中心告警的原因")])]),s._v(" "),a("li",[s._v("排查k8s日志，发现对应时间点，容器进程内存占用超过了k8s配置文件对requests.limit的限制，最终导致k8s强制关闭容器")]),s._v(" "),a("li",[s._v("排查容器内存指标，能看到容器的物理内存在30%~40%左右，但是容器内存持续保持在100%接近1分钟")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdmirror.com/gh/kkyeer/picbed/memUsage_aom_combined.svg",alt:"memUsage_aom_combined"}}),s._v(" "),a("img",{attrs:{src:"https://cdn.jsdmirror.com/gh/kkyeer/picbed/memUsed_aom_combined.svg",alt:"memUsed_aom_combined"}})]),s._v(" "),a("p",[s._v("经过上述的快速排查，引入了几个问题")]),s._v(" "),a("p",[s._v("问题1: 物理内存和容器内存为什么差距这么大？\n问题2: 容器内存具体是什么在占用？")]),s._v(" "),a("p",[s._v("解决上述问题需要了解进程的内存统计以及CGroup的内存统计，有必要进行一定的知识补全")]),s._v(" "),a("h2",{attrs:{id:"内存统计知识"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#内存统计知识"}},[s._v("#")]),s._v(" 内存统计知识")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://help.aliyun.com/zh/arms/application-monitoring/developer-reference/memory-metrics",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考资料:常用的内存查询命令/指标的含义是什么_应用实时监控服务(ARMS)-阿里云帮助中心"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.jianshu.com/p/36a1df62cda7",target:"_blank",rel:"noopener noreferrer"}},[s._v("容器内存监控，是看rss还是wss?"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://qingwave.github.io/container-memory/",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考资料：容器内存分析"),a("OutboundLink")],1)])]),s._v(" "),a("h3",{attrs:{id:"linux系统内存分布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#linux系统内存分布"}},[s._v("#")]),s._v(" Linux系统内存分布")]),s._v(" "),a("p",[s._v("Linux系统内存，除系统启动过程中消耗的内存外，剩余内存为系统使用内存，一般使用free命令来查看系统整体的内存占用")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-mh")]),s._v("                                                                                                                                                \n               total        used        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),s._v("      shared  buff/cache    available                                                                    \nMem:            31Gi        15Gi       235Mi       194Mi        15Gi        15Gi\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdmirror.com/gh/kkyeer/picbed/linux_memory2.svg",alt:"linux_memory2"}})]),s._v(" "),a("ol",[a("li",[s._v("total：系统物理内存，在启动时会被启动过程，kdump等组件用掉一部分，剩下的是内核和应用程序可以使用的内存，也是free命令中输出的total字段，比物理内存略小一些")]),s._v(" "),a("li",[s._v("free：完全未分配的内存")]),s._v(" "),a("li",[s._v("buff/cache：由系统管理的缓存")]),s._v(" "),a("li",[s._v("used：total - free - buffers - cache")]),s._v(" "),a("li",[s._v("shared：Shmem共享内存页（对应共享匿名映射、tmpfs、memfd等场景），"),a("strong",[s._v("同时也会算到cache里")])])]),s._v(" "),a("p",[s._v("从第2点可以推断出：total = used + buff/cache + free")]),s._v(" "),a("p",[s._v("其中free很好理解，就是剩余未分配的物理内存，used是减出来的，所以关键是理解buffers和cache内存。")]),s._v(" "),a("h4",{attrs:{id:"关于buffers-cache"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于buffers-cache"}},[s._v("#")]),s._v(" 关于buffers/cache")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/645904515",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考资料"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("man")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nbuffers\n      Memory used by kernel buffers "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Buffers "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" /proc/meminfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\ncache  Memory used by the page cache and slabs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Cached and SReclaimable "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" /proc/meminfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nbuff/cache\n      Sum of buffers and cache\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("可以看出")]),s._v(" "),a("ul",[a("li",[s._v("buffers:内核缓冲区用到的内存【Memory used by kernel buffers (Buffers in /proc/meminfo)】")]),s._v(" "),a("li",[s._v("cache:PageCache和 slab【Memory used by the page cache and slabs (Cached and SReclaimable in /proc/meminfo)】")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("man")]),s._v(" proc\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n  Buffers %lu\n    Relatively temporary storage "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" raw disk blocks that shouldn"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t get tremendously large (20 MB or so).\n  Cached %lu\n    In-memory cache for files read from the disk (the page cache).  Doesn'")]),s._v("t include SwapCached.\n  SReclaimable %lu "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.6")]),s._v(".19"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    Part of Slab, that might be reclaimed, such as caches.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("从下面的图片可以看出，buffer位于相对底层，是文件系统和物理磁盘（块设备）之间的缓冲区，而PageCache是系统内核和文件系统之间的缓冲区。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdmirror.com/gh/kkyeer/picbed/20250612111718.png",alt:"20250612111718"}})]),s._v(" "),a("p",[s._v("另外，linux内核使用 Slab 机制，管理文件系统的目录项和索引节点的缓存。Slab 包括两部分，其中的可回收部分，是指可以被回收的内核内存，包括目录项（dentry） 和索引节点（ inode ）的缓存等，用 SReclaimable 记录；而不可回收部分，用 SUnreclaim 记录。")]),s._v(" "),a("h5",{attrs:{id:"系统cache-buffer回收策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统cache-buffer回收策略"}},[s._v("#")]),s._v(" 系统Cache/Buffer回收策略")]),s._v(" "),a("ol",[a("li",[s._v("系统内存不足时，会尝试异步回收cache>同步回收cache，如果仍旧不足，触发oom")]),s._v(" "),a("li",[s._v("可以通过写入"),a("code",[s._v("/proc/sys/vm/drop_caches")]),s._v("文件来触发系统回收，其中\n"),a("ol",[a("li",[a("code",[s._v("echo 1 > /proc/sys/vm/drop_caches")]),s._v("：释放Cache的干净页")]),s._v(" "),a("li",[a("code",[s._v("echo 2 > /proc/sys/vm/drop_caches")]),s._v("：释放slab")]),s._v(" "),a("li",[a("code",[s._v("echo 1 > /proc/sys/vm/drop_caches")]),s._v("：释放Cache和slab")])])]),s._v(" "),a("li",[s._v("如果想回收Cache的脏页，需要先执行sync，写入磁盘后变为干净页才可以回收")])]),s._v(" "),a("h3",{attrs:{id:"进程内存构成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#进程内存构成"}},[s._v("#")]),s._v(" 进程内存构成")]),s._v(" "),a("p",[s._v("对于一个进程来说，与之相关联的内存可以分为2大类")]),s._v(" "),a("ol",[a("li",[s._v("基于文件的内存页，file-backed-memory:基于文件的内存页，注意，由于linux一切皆是文件的特性，这里的文件除了存储在磁盘上的文件，还包含了一些其他的特殊场景\n"),a("ol",[a("li",[s._v("基于磁盘文件的映射：比如BufferedIO")]),s._v(" "),a("li",[s._v("基于MMAP读取文件：比如数据库一般会直接使用mmap来管理内存和磁盘文件的一致性，mmap方式的优点是避免了bufferedIO的")]),s._v(" "),a("li",[s._v("共享匿名映射：基于/tmpfs的映射，理论上也属于mmap的一种，区别是"),a("strong",[s._v("Linux系统下/tmpfs通常对应物理内存空间而不是磁盘")]),s._v("，常用于父子进程通信")])])]),s._v(" "),a("li",[s._v("匿名内存页，anno-rss：对应通过malloc方法申请的内存")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdmirror.com/gh/kkyeer/picbed/process_memory.svg",alt:"process_memory"}})]),s._v(" "),a("h3",{attrs:{id:"常见内存统计工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见内存统计工具"}},[s._v("#")]),s._v(" 常见内存统计工具")]),s._v(" "),a("h4",{attrs:{id:"cgroup内存统计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cgroup内存统计"}},[s._v("#")]),s._v(" cgroup内存统计")]),s._v(" "),a("p",[s._v("可能是下面的两个路径之一:")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("/sys/fs/cgroup/memory/memory.stat")])]),s._v(" "),a("li",[a("code",[s._v("/sys/fs/cgroup/memory.stat")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /sys/fs/cgroup/memory/memory.stat\ncache "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2042019840")]),s._v("\nrss "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("817131520")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nmapped_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("545329152")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ninactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("490184704")]),s._v("\nactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("949952512")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ntotal_cache "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2042019840")]),s._v("\ntotal_rss "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("817131520")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ntotal_inactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("490184704")]),s._v("\ntotal_active_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("949952512")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("如上，省略了部分项，剩下需要关注的")]),s._v(" "),a("ol",[a("li",[s._v("rss: 匿名内存总和")]),s._v(" "),a("li",[s._v("cache: 类似free命令的cache/buffer，对应所有的file-backend内存")]),s._v(" "),a("li",[s._v("mapped_file: 包含所有mmap的匿名内存(MAP_ANONYMOUS)，包含tmpfs/shmem")]),s._v(" "),a("li",[s._v("active_file: 除匿名内存外的PageCache，注意cgroup统计的是此进程组使用过的所有的文件句柄对应的PageCache，包含打开和关闭（但未被回收的内存页）")]),s._v(" "),a("li",[s._v("inactive_file：active_file中标记为inactive的内存页")])]),s._v(" "),a("p",[s._v("working_set的计算公式："),a("strong",[s._v("working_set = rss + cache - inactive_file")])]),s._v(" "),a("h4",{attrs:{id:"proc-pid-status"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proc-pid-status"}},[s._v("#")]),s._v(" /proc/{pid}/status")]),s._v(" "),a("p",[a("code",[s._v("/proc")]),s._v("文件夹下的内容是进程对应的")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/1/status\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nVmPeak: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("108647580")]),s._v(" kB\nVmSize: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("108516356")]),s._v(" kB\nVmLck:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nVmPin:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nVmHWM:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6072292")]),s._v(" kB\nVmRSS:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1714428")]),s._v(" kB\nRssAnon:          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("591256")]),s._v(" kB\nRssFile:           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18260")]),s._v(" kB\nRssShmem:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1104912")]),s._v(" kB\nVmData: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("107086612")]),s._v(" kB\nVmStk:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("152")]),s._v(" kB\nVmExe:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" kB\nVmLib:     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22832")]),s._v(" kB\nVmPTE:      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4908")]),s._v(" kB\nVmSwap:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nThreads:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("370")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("其中"),a("strong",[s._v("Vm")]),s._v("前缀的内存对应虚拟内存相关指标，"),a("strong",[s._v("由于容器环境的一些限制，可能显示的是宿主机的值，仅供参考")]),s._v("，重点关注RssAnon，RssFile和RssShmem这几个值，其中\nRssAnon为匿名内存，RssFile为文件内存（不包含匿名文件映射），RssShmem为共享文件内存")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("VmSize:\n虚拟内存大小。\n整个进程使用虚拟内存大小，是VmLib, VmExe, VmData, 和 VmStk的总和。")])]),s._v(" "),a("li",[a("p",[s._v("VmLck:\n虚拟内存锁。\n进程当前使用的并且加锁的虚拟内存总数")])]),s._v(" "),a("li",[a("p",[s._v("VmRSS:\n虚拟内存驻留集合大小。\n这是驻留在物理内存的一部分。它没有交换到硬盘。它包括代码，数据和栈。\nVmRSS = RssAnon + RssFile + RssShmem")])]),s._v(" "),a("li",[a("p",[s._v("VmData:\n虚拟内存数据。\n堆使用的虚拟内存。")])]),s._v(" "),a("li",[a("p",[s._v("VmStk:\n虚拟内存栈\n栈使用的虚拟内存")])]),s._v(" "),a("li",[a("p",[s._v("VmExe:\n可执行的虚拟内存\n可执行的和静态链接库所使用的虚拟内存")])]),s._v(" "),a("li",[a("p",[s._v("VmLib:\n虚拟内存库\n动态链接库所使用的虚拟内存")])])]),s._v(" "),a("h4",{attrs:{id:"proc-meminfo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proc-meminfo"}},[s._v("#")]),s._v(" /proc/meminfo")]),s._v(" "),a("p",[s._v("可以根据文件"),a("code",[s._v("/proc/meminfo")]),s._v("的内容来查看整个系统当前的内存占用，free命令的数据也是从这个文件提取再加工的")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/meminfo\nMemTotal:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32779612")]),s._v(" kB\nMemFree:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3916296")]),s._v(" kB\nMemAvailable:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30638252")]),s._v(" kB\nBuffers:          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("855164")]),s._v(" kB\nCached:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24187724")]),s._v(" kB\nSwapCached:           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" kB\nActive:          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3009196")]),s._v(" kB\nInactive:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23054352")]),s._v(" kB\nActive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("anon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1034236")]),s._v(" kB\nInactive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("anon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1388")]),s._v(" kB\nActive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1974960")]),s._v(" kB\nInactive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23052964")]),s._v(" kB\nUnevictable:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1876")]),s._v(" kB\nMlocked:               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nSwapTotal:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2097148")]),s._v(" kB\nSwapFree:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2096124")]),s._v(" kB\nZswap:                 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nZswapped:              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nDirty:               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("156")]),s._v(" kB\nWriteback:             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nAnonPages:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1022560")]),s._v(" kB\nMapped:           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("587176")]),s._v(" kB\nShmem:             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14960")]),s._v(" kB\nKReclaimable:    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2162372")]),s._v(" kB\nSlab:            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2523328")]),s._v(" kB\nSReclaimable:    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2162372")]),s._v(" kB\nSUnreclaim:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("360956")]),s._v(" kB\nKernelStack:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13600")]),s._v(" kB\nPageTables:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28620")]),s._v(" kB\nSecPageTables:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nNFS_Unstable:          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nBounce:                "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nWritebackTmp:          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nCommitLimit:    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18486952")]),s._v(" kB\nCommitted_AS:    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6725936")]),s._v(" kB\nVmallocTotal:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("34359738367")]),s._v(" kB\nVmallocUsed:      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("106192")]),s._v(" kB\nVmallocChunk:          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nPercpu:            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15456")]),s._v(" kB\nHardwareCorrupted:     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nAnonHugePages:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nShmemHugePages:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nShmemPmdMapped:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nFileHugePages:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nFilePmdMapped:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nUnaccepted:            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nHugePages_Total:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nHugePages_Free:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nHugePages_Rsvd:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nHugePages_Surp:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nHugepagesize:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v(" kB\nHugetlb:               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" kB\nDirectMap4k:      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("604784")]),s._v(" kB\nDirectMap2M:    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17135616")]),s._v(" kB\nDirectMap1G:    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15728640")]),s._v(" kB\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br")])]),a("blockquote",[a("p",[s._v("掌握上述基本知识后，尝试分析解决最初的内存问题，基本思路是先尝试复现，在复现的基础上收集内存指标，通过观察、对比和实验确定问题点，然后进行修复，最后观察修复效果并复盘")])]),s._v(" "),a("h2",{attrs:{id:"问题复现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题复现"}},[s._v("#")]),s._v(" 问题复现")]),s._v(" "),a("ol",[a("li",[s._v("问题发生在生产环境，尝试在测试环境寻找有相同问题的应用，\n"),a("ol",[a("li",[s._v("范围：最近7天内，应用重启次数大于1。")]),s._v(" "),a("li",[s._v("结果没有找到")])])]),s._v(" "),a("li",[s._v("考虑到题跟Java容器的内存相关，怀疑是否跟JVM有关，尝试写代码mock堆内存压力升高的场景，看看是否可以复现")])]),s._v(" "),a("h3",{attrs:{id:"模拟堆内存压力"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模拟堆内存压力"}},[s._v("#")]),s._v(" 模拟堆内存压力")]),s._v(" "),a("p",[s._v("思路： 通过代码来占用较大量的堆内存，观察working_set在此前后的变化，判断问题是否产生在堆上。")]),s._v(" "),a("blockquote",[a("p",[s._v("首先观察容器初始的状态")])]),s._v(" "),a("h4",{attrs:{id:"初始状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始状态"}},[s._v("#")]),s._v(" 初始状态")]),s._v(" "),a("ul",[a("li",[s._v("从指标监测看到，物理内存使用量是0.46G左右，WorkingSet使用量为0.88G，有0.88-0.46=0.42G的GAP")]),s._v(" "),a("li",[s._v("命令行查看内存占用明细")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /sys/fs/cgroup/memory/memory.usage_in_bytes \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("966750208")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".9G\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /sys/fs/cgroup/memory/memory.stat\ncache "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("461389824")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".44G\nrss "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("512860160")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".48G\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nmapped_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("350171136")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".33G\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ninactive_anon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("341835776")]),s._v("\nactive_anon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("546357248")]),s._v("\ninactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("294912")]),s._v("\nactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("85704704")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".081G\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("可以看到堆内存（RSS物理内存）占用0.48G，PageCache约为0.08G，匿名内存页约为0.33G，乍看上去一切正常")]),s._v(" "),a("h4",{attrs:{id:"提升堆占用后的状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#提升堆占用后的状态"}},[s._v("#")]),s._v(" 提升堆占用后的状态")]),s._v(" "),a("p",[s._v("相关代码如下，每次调用会占用x MB大小的堆内存，且线程睡眠一定时间内不会释放或者GC")]),s._v(" "),a("div",{staticClass:"language-Java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/increase-memory"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JsonResult")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Boolean")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("increaseMemory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RequestParam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"x"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RequestParam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" bytes "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JsonResult")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("调用参数：x = 300，s=1000000，连续调用3次后，理论上会在对上分配300*3=900M内存，1000秒后释放。")]),s._v(" "),a("p",[s._v("GC前内存占用：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /sys/fs/cgroup/memory/memory.stat\ncache "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1406787584")]),s._v("  ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".31G\nrss "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("495648768")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".46G \nrss_huge "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nmapped_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1304526848")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".21G\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ninactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10440704")]),s._v("\nactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("85626880")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("unset")]),s._v(" JAVA_TOOL_OPTIONS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("jhsdb jmap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--heap")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--pid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nAttaching to process ID "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", please wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nDebugger attached successfully.\nServer compiler detected.\nJVM version is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17.0")]),s._v(".10+11-LTS-240\n\nusing thread-local object allocation.\nZGC with "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nHeap Configuration:\n   MinHeapFreeRatio         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("\n   MaxHeapFreeRatio         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("70")]),s._v("\n   MaxHeapSize              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1933574144")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1844")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   NewSize                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1363144")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".2999954223632812MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   MaxNewSize               "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17592186044415")]),s._v(" MB\n   OldSize                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5452592")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(".1999969482421875MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   NewRatio                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n   SurvivorRatio            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n   MetaspaceSize            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22020096")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   CompressedClassSpaceSize "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("218103808")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("208")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   MaxMetaspaceSize         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("268435456")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   G1HeapRegionSize         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nHeap Usage:\n ZHeap          used 1140M, capacity 1250M, max capacity 1844M\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br")])]),a("p",[s._v("GC后")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /sys/fs/cgroup/memory/memory.stat\ncache "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1617858560")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".5G\nrss "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("525516800")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".48G\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nmapped_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1476038656")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".37G\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ninactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10690560")]),s._v("\nactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("107704320")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".1G\n\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("unset")]),s._v(" JAVA_TOOL_OPTIONS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("jhsdb jmap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--heap")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--pid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nAttaching to process ID "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", please wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nDebugger attached successfully.\nServer compiler detected.\nJVM version is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17.0")]),s._v(".10+11-LTS-240\n\nusing thread-local object allocation.\nZGC with "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nHeap Configuration:\n   MinHeapFreeRatio         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("\n   MaxHeapFreeRatio         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("70")]),s._v("\n   MaxHeapSize              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1933574144")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1844")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   NewSize                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1363144")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".2999954223632812MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   MaxNewSize               "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17592186044415")]),s._v(" MB\n   OldSize                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5452592")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(".1999969482421875MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   NewRatio                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n   SurvivorRatio            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n   MetaspaceSize            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22020096")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   CompressedClassSpaceSize "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("218103808")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("208")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   MaxMetaspaceSize         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("268435456")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   G1HeapRegionSize         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".0MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nHeap Usage:\n ZHeap          used 286M, capacity 1430M, max capacity 1844M\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br")])]),a("p",[s._v("可以看到，相比较初始状态，rss并没有明显变化，反而cache和mapped_file增加了约900M，引入了新问题：ZGC的堆分配对应cgroup的cache(mapped_file)部分，与以往JDK8不一致（JDK8堆分配在RSS），结合前面的内存分布知识，mapped_file属于cache的一部分，难道ZGC的堆不在匿名内存里？")]),s._v(" "),a("h3",{attrs:{id:"zgc堆内存分配区域研究"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zgc堆内存分配区域研究"}},[s._v("#")]),s._v(" ZGC堆内存分配区域研究")]),s._v(" "),a("p",[s._v("在查询资料解决上述问题的同时，我们也观察了同样的场景在G1下的表现，与预期一致，堆占用提升，并不会导致cache部分的提升，且RSS部分的数量约等于配置的堆上限，可见G1收集器堆内存对应RSS部分。")]),s._v(" "),a("p",[s._v("进一步的查阅资料后发现，ZGC的堆内存，底层使用"),a("code",[s._v("memfd_create")]),s._v("方法，具体如下")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" ZPhysicalMemoryBacking"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create_mem_fd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Create file")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" extra_flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ZLargePages"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("is_explicit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("MFD_HUGETLB "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" MFD_HUGE_2MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" fd "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ZSyscall"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("memfd_create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" MFD_CLOEXEC "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" extra_flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log_info_p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Heap Backing File: /memfd:%s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("查阅Linux的man page看，"),a("code",[s._v("memfd_create")]),s._v("方法创建一个匿名文件fd，再使用mmap方法来二次加载到虚拟内存中，所以这部分内存属于mmap内存。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("MEMFD_CREATE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                                                    Linux Programmer's Manual                                                    MEMFD_CREATE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nNAME\n       memfd_create - create an anonymous "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v("\n\nSYNOPSIS\n       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#define _GNU_SOURCE         /* See feature_test_macros(7) */")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#include <sys/mman.h>")]),s._v("\n\n       int memfd_create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("const char *name, unsigned int flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nDESCRIPTION\n       memfd_create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" creates an anonymous "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" and returns a "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" descriptor that refers to it.  The "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" behaves like a regular file, and so can be modified,\n       truncated, memory-mapped, and so on.  However, unlike a regular file, it lives "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" RAM and has a volatile backing storage.  Once all  references  to  the\n       "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" are dropped, it is automatically released.  Anonymous memory is used "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" all backing pages of the file.  Therefore, files created by memfd_create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n       have the same semantics as other anonymous memory allocations such as those allocated using mmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" with the MAP_ANONYMOUS flag\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("通过进程的"),a("code",[s._v("smaps")]),s._v("命令来验证上述内存")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/1/maps "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" heap\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000000000")]),s._v("-40000600000 rw-s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16200000")]),s._v(" 00:04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4098814597")]),s._v("                   /memfd:java_heap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deleted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000600000")]),s._v("-40001800000 rw-s 16a00000 00:04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4098814597")]),s._v("                   /memfd:java_heap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deleted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40001800000")]),s._v("-40001a00000 rw-s 17e00000 00:04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4098814597")]),s._v("                   /memfd:java_heap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deleted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n40001a00000-40001e00000 rw-s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18200000")]),s._v(" 00:04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4098814597")]),s._v("                   /memfd:java_heap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deleted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40002600000")]),s._v("-40002a00000 rw-s 02600000 00:04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4098814597")]),s._v("                   /memfd:java_heap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deleted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n40002e00000-40003000000 rw-s 02e00000 00:04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4098814597")]),s._v("                   /memfd:java_heap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deleted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40004800000")]),s._v("-40004a00000 rw-s 04800000 00:04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4098814597")]),s._v("                   /memfd:java_heap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deleted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("至此，ZGC的堆内存分配区域理解完成，但是，即使所有的PageCache+RSS，也就2.5G左右，离问题触发时4G的阈值相去甚远，剩余的working_set内存都在哪里？要解决这个问题，还是希望能有一个相对稳定的复现流程。")]),s._v(" "),a("p",[s._v("考虑到问题服务在JDK8上没有问题，那问题是否跟GC过程有关？下一步模拟下大量GC的过程，看看是否可以复现。")]),s._v(" "),a("h3",{attrs:{id:"尝试大量触发gc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#尝试大量触发gc"}},[s._v("#")]),s._v(" 尝试大量触发GC")]),s._v(" "),a("p",[s._v("思路：在堆内存占用已经很大的前提下，尝试申请内存、使用内存、释放的循环。")]),s._v(" "),a("div",{staticClass:"language-Java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/trigger-fullgc"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JsonResult")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Boolean")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("triggerFullGC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RequestParam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"m"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RequestParam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                          "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RequestParam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"t"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" times"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" times"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 循环创建内存，使用，释放")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("triggerFullGC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JsonResult")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("triggerFullGC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" bytes "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/increase-memory"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JsonResult")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Boolean")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("increaseMemory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RequestParam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"m"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RequestParam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 一次性占用大量内存")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" bytes "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JsonResult")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("p",[s._v("最终没有复现线上的问题，堆上的内存分配-释放循环，不会导致PageCache进一步提升，说明"),a("strong",[s._v("堆内存不是导致内存超限的原因")]),s._v("。")]),s._v(" "),a("p",[s._v("复现的过程陷入僵局，睡了一觉以后，考虑思路做一个转换，考虑寻找接近复现的服务")]),s._v(" "),a("h2",{attrs:{id:"寻找问题相近的服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#寻找问题相近的服务"}},[s._v("#")]),s._v(" 寻找问题相近的服务")]),s._v(" "),a("p",[s._v("测试环境尝试寻找接近超限的容器，查询条件为working_set>3G且容器内存=4G，找到多个服务，选择典型且个人熟悉的服务观察。")]),s._v(" "),a("p",[s._v("查看当前cgroup内存状态如下，可以看到active_file为1.13G左右，偏高")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /sys/fs/cgroup/memory/memory.stat\ncache "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2944737280")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".74G\nrss "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1069068288")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".99G\nrss_huge "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("448790528")]),s._v("\nmapped_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1361448960")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".26G\nswap "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\npgpgin "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33070432")]),s._v("\npgpgout "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32208029")]),s._v("\npgfault "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("52502832")]),s._v("\npgmajfault "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\ninactive_anon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1421869056")]),s._v("\nactive_anon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1083723776")]),s._v("\ninactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("295665664")]),s._v(" ≈ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".27G\nactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1212522496")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".13G\nunevictable "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nhierarchical_memory_limit "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4294967296")]),s._v("\nhierarchical_memsw_limit "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4294967296")]),s._v("\ntotal_cache "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2944737280")]),s._v("\ntotal_rss "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1069068288")]),s._v("\ntotal_rss_huge "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("448790528")]),s._v("\ntotal_mapped_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1361448960")]),s._v("\ntotal_swap "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_pgpgin "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_pgpgout "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_pgfault "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_pgmajfault "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_inactive_anon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1421869056")]),s._v("\ntotal_active_anon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1083723776")]),s._v("\ntotal_inactive_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("295665664")]),s._v("\ntotal_active_file "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1212522496")]),s._v("\ntotal_unevictable "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("p",[s._v("从理论上分析，active_file对应的文件的page_cache，大部分为jar包，lib.so，以及少量IO对应的socket，前者启动时就加载，在前面分析过程中冷启动可以看出，大概在500M左右，远小于1.13G，这里有问题，需要进一步分析细节。")]),s._v(" "),a("h2",{attrs:{id:"问题服务pagecache分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题服务pagecache分析"}},[s._v("#")]),s._v(" 问题服务PageCache分析")]),s._v(" "),a("p",[s._v("掏出各路AI来分析了一下，AI推荐PageCache从下列文件中获得")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/1/smaps\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("使用AI快速编写了一个排序脚本，发现smaps排在前面的是堆内存块，且rss总数只有500M，不对，需要重新寻找。\n再次通过AI搜索，找到一个可以查询page_cache的库："),a("a",{attrs:{href:"https://github.com/rfyiamcool/pgcacher",target:"_blank",rel:"noopener noreferrer"}},[s._v("pgcacher"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/rfyiamcool/pgcacher\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" a+x pgcacher\n./pgcacher "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-pid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("上述运行以后的结果如文件:"),a("RouterLink",{attrs:{to:"/views/issue/k8s_oom_killer/pgcacher.html"}},[s._v("output")])],1),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ ./pgcacher "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-pid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n+----------------------------------------------------------------------------------------+----------------+-------------+----------------+-------------+---------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Name                                                                                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Size           │ Pages       │ Cached Size    │ Cached Pages│ Percent │\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("----------------------------------------------------------------------------------------+----------------+-------------+----------------+-------------+---------"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /logs/skywalking.log                                               "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("270")]),s._v(".131M       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("69154")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("270")]),s._v(".131M       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("69154")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /usr/lib/jvm/jdk-17-oracle-x64/lib/modules                                             "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("121")]),s._v(".238M       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31037")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("121")]),s._v(".238M       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31037")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /data/logs/serviceA/access.log                                                         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("104")]),s._v(".286M       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26698")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("104")]),s._v(".286M       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26698")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /data/logs/gc2025-05-22_16-02-46.log                                                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("91")]),s._v(".887M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23524")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("91")]),s._v(".231M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23356")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.286")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /data/logs/serviceA/warn.log                                                           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89")]),s._v(".316M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22866")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89")]),s._v(".316M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22866")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /opt/serviceA.jar                                                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("188")]),s._v(".411M       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("48234")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("78")]),s._v(".932M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20207")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("41.894")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /data/logs/serviceA/error.log                                                          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("61")]),s._v(".573M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15763")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("61")]),s._v(".573M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15763")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /data/logs/serviceA/info.log                                                           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v(".952M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8436")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v(".952M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8436")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /usr/lib/jvm/jdk-17-oracle-x64/lib/server/libjvm.so                                    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(".869M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5599")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(".869M        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5599")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("----------------------------------------------------------------------------------------+----------------+-------------+----------------+-------------+---------"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n│ Sum                                                                                    │ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".025G         │ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("268758")]),s._v("      │ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("939")]),s._v(".132M       │ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("240488")]),s._v("      │ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89.481")]),s._v("  │\n+----------------------------------------------------------------------------------------+----------------+-------------+----------------+-------------+---------+\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("pageCache总计有1G左右，与上面的统计对应，能看到最大的是skywalking.log文件，文件270M，占用的cache也约为这个值，需要优化。\n顺手打开文件看看内容，可以看到有大量的报错，需要解决。同时，应用的info、warn等日志也比较大，有优化空间。")]),s._v(" "),a("h2",{attrs:{id:"根因分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#根因分析"}},[s._v("#")]),s._v(" 根因分析")]),s._v(" "),a("p",[s._v("应用打开的文件有一些大文件，打开文件对应需要使用PageCache，占用内存")]),s._v(" "),a("ol",[a("li",[s._v("skywaking-log 最大300M")]),s._v(" "),a("li",[s._v("access-log 最大512M")]),s._v(" "),a("li",[s._v("业务日志，4个级别，配置单文件最大为128M")])]),s._v(" "),a("p",[s._v("仅上述这部分PageCahce加和极限情况下能达到（128M*4+300M+512M）=1.3G，加上目前启动固定内存占用有")]),s._v(" "),a("ol",[a("li",[s._v("2G：堆")]),s._v(" "),a("li",[s._v("0.786G：元空间+CodeCache")]),s._v(" "),a("li",[s._v("0.4G：依赖包固定的PageCache(so库，jar包, GC Log）\n加起来=4.4G，考虑到还有网络I/O等的内存占用，所以很多情况下会导致OOM")])]),s._v(" "),a("h2",{attrs:{id:"解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[s._v("#")]),s._v(" 解决方案")]),s._v(" "),a("ol",[a("li",[s._v("解决探针日志skywalking-api.log中对应的异常")]),s._v(" "),a("li",[s._v("skywalking-api.log文件过大，需要缩小或进行chunk")]),s._v(" "),a("li",[s._v("日志：access.log 过大，需要进行chunk")]),s._v(" "),a("li",[s._v("应用日志：warn.log，info.log等，单文件过大，需要调整："),a("code",[s._v("<maxFileSize>128MB</maxFileSize>")]),s._v("修改应用配置")])]),s._v(" "),a("h2",{attrs:{id:"效果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#效果"}},[s._v("#")]),s._v(" 效果")]),s._v(" "),a("p",[s._v("测试环境验证：上述解决方案上线后，应用的working_set平均降低30%")]),s._v(" "),a("h2",{attrs:{id:"复盘"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#复盘"}},[s._v("#")]),s._v(" 复盘")]),s._v(" "),a("p",[s._v("事后看，在最初尝试复现问题时，走了一些弯路，最后也没有成功复盘，最终是通过寻找"),a("strong",[s._v("问题相近服务")]),s._v("破局，后续可以更灵活的调整问题切入的视角和思路。")]),s._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://help.aliyun.com/zh/arms/application-monitoring/developer-reference/memory-metrics",target:"_blank",rel:"noopener noreferrer"}},[s._v("常用的内存查询命令/指标的含义是什么_应用实时监控服务(ARMS)-阿里云帮助中心"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.jianshu.com/p/36a1df62cda7",target:"_blank",rel:"noopener noreferrer"}},[s._v("容器内存监控，是看rss还是wss?"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://qingwave.github.io/container-memory/",target:"_blank",rel:"noopener noreferrer"}},[s._v("容器内存分析"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://dbaplus.cn/news-134-6386-1.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("大受震撼！K8s里我的容器到底用了多少内存？"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://developer.aliyun.com/article/726120",target:"_blank",rel:"noopener noreferrer"}},[s._v("带你读《新一代垃圾回收器ZGC设计与实现》之二：ZGC内存管理"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/601691903",target:"_blank",rel:"noopener noreferrer"}},[s._v("Linux内存映射"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/a860MHz/article/details/99435257",target:"_blank",rel:"noopener noreferrer"}},[s._v("OpenJDK ZGC 源码分析（三）内存管理"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://juejin.cn/post/7016936265161375752",target:"_blank",rel:"noopener noreferrer"}},[s._v("技术翻译」JVM研究系列「绝版敲门砖」带你进入JVM-ZGC垃圾回收器的时代和未来"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/openjdk/jdk/blob/master/src/hotspot/os/linux/gc/z/zPhysicalMemoryBacking_linux.cpp#L202",target:"_blank",rel:"noopener noreferrer"}},[s._v("ZGC内存分配源码"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/645904515",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考资料"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&mid=2247486732&idx=1&sn=435d5e834e9751036c96384f6965b328&chksm=ce77cb4bf900425d33d2adfa632a4684cf7a63beece166c1ffedc4fdacb807c9413e8c73f298&scene=178&cur_album_id=2559805446807928833#rd",target:"_blank",rel:"noopener noreferrer"}},[s._v("一步一图带你深入理解 Linux 虚拟内存管理"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);
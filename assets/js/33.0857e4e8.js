(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{470:function(a,t,s){"use strict";s.r(t);var n=s(2),e=Object(n.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"一次元空间fullgc导致oom问题分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一次元空间fullgc导致oom问题分析"}},[a._v("#")]),a._v(" 一次元空间FullGC导致OOM问题分析")]),a._v(" "),t("h2",{attrs:{id:"现象"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#现象"}},[a._v("#")]),a._v(" 现象")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('1. 观测平台告警：FullGC次数大于阈值，5分钟内大于11次，频次大概1-2周有一次\n2. 告警后服务概率性会自动恢复，控制台打印\n\n    ```shell\n    Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread "Thread-17"\n    Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread "SimpleAsyncTaskExecutor-1"\n    ```\n\n3. 不自动恢复时，服务对应容器会挂掉，需要被kill\n')])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br")])]),t("h2",{attrs:{id:"过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#过程"}},[a._v("#")]),a._v(" 过程")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("首先查看监控平台截取的部分GC日志，发现FullGC出现在MetaSpace元空间")])]),a._v(" "),t("li",[t("p",[a._v("下载完整的GC日志分析，暂时未发现更多线索")])]),a._v(" "),t("li",[t("p",[a._v("将堆整体Dump下来，上传"),t("a",{attrs:{href:"https://memory.console.heapdump.cn",target:"_blank",rel:"noopener noreferrer"}},[a._v("HeapDump"),t("OutboundLink")],1),a._v("网站分析，在“类加载器”视图发现有大量的"),t("code",[a._v("sun.reflect.DelegatingClassLoader")]),a._v("类加载器，且大部分只加载了1个类: "),t("code",[a._v("sun.reflect.GeneratedMethodAccessor6036")]),a._v("。")]),a._v(" "),t("ol",[t("li",[a._v("疑问1: "),t("code",[a._v("sun.reflect.DelegatingClassLoader")]),a._v("类加载器是做什么的？")]),a._v(" "),t("li",[a._v("疑问2: 为什么有7000个"),t("code",[a._v("DelegatingClassLoader类加载器")]),a._v("类加载器？类加载器有一个不就够了，毕竟是用来加载别的类的。")]),a._v(" "),t("li",[a._v("疑问3: 为什么类加载器只加载1个类？"),t("code",[a._v("sun.reflect.GeneratedMethodAccessor6036")]),a._v("相似的类为什么有7000多个")]),a._v(" "),t("li",[a._v("疑问4: 为什么这些类加载器的parent类加载器是"),t("code",[a._v("org.springframework.boot.loader.LaunchedURLClassLoader")]),a._v("？")])]),a._v(" "),t("p",[a._v("解决了上面的上面的疑问，对于问题最终的定位应该有极大的帮助")])])]),a._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/kkyeer/picbed/20240114090610.png",alt:"20240114090610"}})]),a._v(" "),t("h2",{attrs:{id:"反射与sun-reflect-delegatingclassloader"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#反射与sun-reflect-delegatingclassloader"}},[a._v("#")]),a._v(" 反射与sun.reflect.DelegatingClassLoader")]),a._v(" "),t("blockquote",[t("p",[a._v("按以往所学的双亲委派和Spring的知识，加载器一般只有"),t("code",[a._v("BootStrap")]),a._v("，"),t("code",[a._v("AppClassLoader")]),a._v("，"),t("code",[a._v("ExtClassLoader")]),a._v("，再加上Spring的"),t("code",[a._v("LaunchedURLClassLoader")]),a._v("几种，且数量不会太多，毕竟是类"),t("strong",[a._v("加载器")]),a._v("，有一个能把类加载进VM即可")])]),a._v(" "),t("p",[a._v("经过对"),t("code",[a._v("DelegatingClassLoader")]),a._v("关键字的检索，大部分网页都提到了反射，参考"),t("a",{attrs:{href:"https://www.jianshu.com/p/20b7ab284c0a",target:"_blank",rel:"noopener noreferrer"}},[a._v("简书这篇贴子"),t("OutboundLink")],1),a._v("的方案，结合自己的理解，验证代码如下")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("TestReflection")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("SomePojo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),a._v(" f1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getF1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" f1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("throws")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("NoSuchMethodException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InvocationTargetException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("IllegalAccessException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InterruptedException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Method")]),a._v(" method "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("SomePojo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getDeclaredMethod")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"getF1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("SomePojo")]),a._v(" target "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("SomePojo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        target"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("f1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"aaa"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("15")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("invoke")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("target"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),a._v(" result "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("invoke")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("target"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br")])]),t("p",[a._v("在"),t("code",[a._v("sun.reflect.NativeMethodAccessorImpl#invoke")]),a._v("方法里，针对某个方法反射的次数不同有2种方案")]),a._v(" "),t("ol",[t("li",[a._v("反射调用15次及以下的时候，使用字节码解释执行")]),a._v(" "),t("li",[a._v("反射调用15次以上的时候，值得为此构建一个专门的类来调用反射，虽然这第16次会慢，但是后续因为JIT的原因会大大变快")])]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[a._v("    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Object")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("invoke")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Object")]),a._v(" obj"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Object")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("throws")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("IllegalArgumentException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InvocationTargetException")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 当反射调用次数>阈值15次的时候，会调用new MethodAccessorGenerator().generateMethod方法来实现invoke")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),a._v("numInvocations "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("ReflectionFactory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("inflationThreshold")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("ReflectUtil")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("isVMAnonymousClass")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getDeclaringClass")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MethodAccessorImpl")]),a._v(" acc "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MethodAccessorImpl")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MethodAccessorGenerator")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("\n                    "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("generateMethod")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getDeclaringClass")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n                                   method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n                                   method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getParameterTypes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n                                   method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getReturnType")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n                                   method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getExceptionTypes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n                                   method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getModifiers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            parent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("setDelegate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 当反射调用次数<=阈值15次的时候，使用native的字节码解释执行来实现invoke")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("invoke0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" obj"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br")])]),t("p",[a._v("问题就出在多次反射调用的"),t("code",[a._v("new MethodAccessorGenerator().generateMethod")]),a._v("方法，此方法内部最终会调用如下代码来生成一个Class，过程中有2步操作涉及到类的创建")]),a._v(" "),t("ol",[t("li",[a._v("新创建一个ClassLoader:"),t("code",[a._v("sun.reflect.DelegatingClassLoader")]),a._v(",父类加载器是"),t("strong",[a._v("反射调用者")]),a._v("的类加载器")]),a._v(" "),t("li",[a._v("新构造一个类，使用上面新的ClassLoader来加载")])]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Class")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("?")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("defineClass")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),a._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("byte")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" off"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" len"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n                                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("ClassLoader")]),a._v(" parentClassLoader"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("ClassLoader")]),a._v(" newLoader "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("AccessController")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("doPrivileged")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PrivilegedAction")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("ClassLoader")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("ClassLoader")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("run")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("DelegatingClassLoader")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("parentClassLoader"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" unsafe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("defineClass")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" off"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" len"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" newLoader"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br")])]),t("p",[a._v("核心代码的时序见下图：")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/kkyeer/picbed/Sequence_20240104213019.svg",alt:"Sequence_20240104213019"}})]),a._v(" "),t("p",[a._v("上面可以解释疑问1和疑问3，疑问2也很简单，既然反射调用的时候会对"),t("strong",[a._v("每一个方法")]),a._v("来调用上面的逻辑，在POJO很多的服务中，大量应用反射来调用"),t("code",[a._v("settter")]),a._v("和"),t("code",[a._v("gettter")]),a._v("方法，自然会导致**7000+**的"),t("code",[a._v("DelegatingClassLoader")]),a._v("类加载器和对应的"),t("code",[a._v("sun.reflect.GeneratedMethodAccessor")])]),a._v(" "),t("blockquote",[t("ol",[t("li",[a._v("疑问1: "),t("code",[a._v("sun.reflect.DelegatingClassLoader")]),a._v("类加载器是做什么的？----反射用的")]),a._v(" "),t("li",[a._v("疑问2: 为什么有7000个"),t("code",[a._v("DelegatingClassLoader类加载器")]),a._v("类加载器？类加载器有一个不就够了，毕竟是用来加载别的类的？----JDK内部实现如此，具体为什么这么实现待确认")]),a._v(" "),t("li",[a._v("疑问3: 为什么类加载器只加载1个类？"),t("code",[a._v("sun.reflect.GeneratedMethodAccessor6036")]),a._v("相似的类为什么有？----JDK内部实现如此，具体为什么这么实现待挖掘")])])]),a._v(" "),t("p",[a._v("至此，表面上看是因为代码中反射用的太多导致，下一步是需要定位具体有哪些地方用到了反射，除了MetaSpace的参数修改（线上用-XX:MaxMetaspaceSize=256m 参数限定了最大空间），还需要注意哪些？")]),a._v(" "),t("blockquote",[t("p",[t("em",[a._v("彩蛋，生成类名的逻辑")])])]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("synchronized")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("generateName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("boolean")]),a._v(" isConstructor"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n                                                    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("boolean")]),a._v(" forSerialization"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("isConstructor"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("forSerialization"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),a._v("serializationConstructorSymnum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"sun/reflect/GeneratedSerializationConstructorAccessor"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),a._v("constructorSymnum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"sun/reflect/GeneratedConstructorAccessor"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),a._v("methodSymnum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"sun/reflect/GeneratedMethodAccessor"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" \n            ↑↑↑↑这里就是生成的反射调用类的类名，可以看到有一个数字尾号，是一个全局的自增数字\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br")])]),t("h2",{attrs:{id:"疑点2-被springlaunchedurlclassloader加载的delegatingclassloader"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#疑点2-被springlaunchedurlclassloader加载的delegatingclassloader"}},[a._v("#")]),a._v(" 疑点2:被"),t("code",[a._v("SpringLaunchedURLClassLoader")]),a._v("加载的"),t("code",[a._v("DelegatingClassLoader")]),a._v("?")]),a._v(" "),t("blockquote",[t("p",[t("code",[a._v("DelegatingClassLoader")]),a._v("的父类加载器为调用者的类加载器，当本地调试时，由于IDEA自动解析并把依赖jar包放入classpath,最终所有依赖是App类加载器载入，所以"),t("code",[a._v("DelegatingClassLoader")]),a._v("的父类加载器为"),t("code",[a._v("sun.misc.Launcher$AppClassLoader")]),a._v("；当生产环境运行时，运行的是Spring打包出的FatJar，依赖也在其中，此时依赖的类（举例：Gson）是由Spring的UrlClassLoader加载，因此反射的父类加载器也为"),t("code",[a._v("SpringLaunchedURLClassLoader")])])]),a._v(" "),t("p",[a._v("明白了反射的原理后，接下来需要定位导致OOM的原因，有2种可能")]),a._v(" "),t("ol",[t("li",[a._v("第三方SDK等原因导致目标应用加载的类"),t("strong",[a._v("异常增加")])]),a._v(" "),t("li",[a._v("因为长期滥用反射，导致现有的256M空间不足以支撑业务运行")])]),a._v(" "),t("p",[a._v("定位上述原因有多种方案，比如临时扩容元空间，查看内存占用是否会无序增长。在运维修改发布参数的同时，好奇看看生成的"),t("code",[a._v("GeneratedMethodAccessor")]),a._v("在堆快照里是否有线索？")]),a._v(" "),t("p",[a._v("考虑到"),t("code",[a._v("sun.reflect.GeneratedMethodAccessor6036")]),a._v("类名后缀的4位是自增的，而应用启动越往后生成的越有可能是最终导致OOM的罪魁祸首（也有可能是冲垮大堤的最后一只蚂蚁），因此从类名+后缀4位入手倒着查。"),t("br"),a._v(" "),t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/kkyeer/picbed/20240114090654.png",alt:"20240114090654"}})]),a._v(" "),t("p",[a._v("最后的680x这些类，看到一片待回收的对象，抽查后发现类加载器的父类加载器都是 "),t("code",[a._v("org.springframework.boot.loader.LaunchedURLClassLoader")]),t("br"),a._v(" "),t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/kkyeer/picbed/20240114090721.png",alt:"20240114090721"}})]),a._v(" "),t("p",[a._v("在堆上更进一步的挖掘，没有找到更多有用的信息，考虑使用Arthas的stack命令来监控Spring的哪些位置使用了反射？以及为什么容器运行了7天后还有反射，是invoke的次数少没有达到15次？还是边缘代码路径？")]),a._v(" "),t("h2",{attrs:{id:"arthas-trace"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#arthas-trace"}},[a._v("#")]),a._v(" Arthas trace")]),a._v(" "),t("p",[a._v("Arthas的使用不是本文的重点，不再赘述，此处仅列举"),t("code",[a._v("stack")]),a._v("指令相关内容。")]),a._v(" "),t("ol",[t("li",[a._v("对于有JAVA_TOOL_OPTIONS注入的，外部启动arthas的流程")])]),a._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("unset")]),a._v(" JAVA_TOOL_OPTIONS\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("java")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-jar")]),a._v(" arthas/arthas-boot.jar\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[a._v("进入以后，先选择进程")])]),a._v(" "),t("div",{staticClass:"language-console line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("options unsafe true\nstack sun.reflect.MethodAccessorGenerator generateMethod >> stack-monitor-reflect.out &\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[a._v("一定要"),t("strong",[a._v("正常exit")])])]),a._v(" "),t("p",[a._v("最后拿到输出举例如下")]),a._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("ts")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2024")]),a._v("-01-10 "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":22:32"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("thread_name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("http-nio-8080-exec-1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("id")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("17")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("is_daemon")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("priority")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("TCCL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@3ee0fea4\n    @sun.reflect.MethodAccessorGenerator.generateMethod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at sun.reflect.NativeMethodAccessorImpl.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NativeMethodAccessorImpl.java:53"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("DelegatingMethodAccessorImpl.java:43"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at java.lang.reflect.Method.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("Method.java:498"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\n\t\t↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓关注这里↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓\n        at org.springframework.beans.BeanUtils.copyProperties"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("BeanUtils.java:821"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.beans.BeanUtils.copyProperties"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("BeanUtils.java:719"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at com.kkyeer.study.spring.controller.DemoController.pingPong2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("DemoController.java:32"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑\n\t\t\n        at sun.reflect.NativeMethodAccessorImpl.invoke0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NativeMethodAccessorImpl.java:-2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at sun.reflect.NativeMethodAccessorImpl.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NativeMethodAccessorImpl.java:62"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("DelegatingMethodAccessorImpl.java:43"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at java.lang.reflect.Method.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("Method.java:498"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("InvocableHandlerMethod.java:205"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("InvocableHandlerMethod.java:150"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ServletInvocableHandlerMethod.java:117"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("RequestMappingHandlerAdapter.java:895"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("RequestMappingHandlerAdapter.java:808"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("AbstractHandlerMethodAdapter.java:87"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.servlet.DispatcherServlet.doDispatch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("DispatcherServlet.java:1071"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.servlet.DispatcherServlet.doService"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("DispatcherServlet.java:964"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.servlet.FrameworkServlet.processRequest"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("FrameworkServlet.java:1006"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.servlet.FrameworkServlet.doPost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("FrameworkServlet.java:909"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at javax.servlet.http.HttpServlet.service"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("HttpServlet.java:696"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.servlet.FrameworkServlet.service"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("FrameworkServlet.java:883"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at javax.servlet.http.HttpServlet.service"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("HttpServlet.java:779"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:227"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:162"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.tomcat.websocket.server.WsFilter.doFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("WsFilter.java:53"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:189"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:162"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.filter.RequestContextFilter.doFilterInternal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("RequestContextFilter.java:100"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("OncePerRequestFilter.java:117"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:189"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:162"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.filter.FormContentFilter.doFilterInternal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("FormContentFilter.java:93"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("OncePerRequestFilter.java:117"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:189"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:162"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("CharacterEncodingFilter.java:201"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("OncePerRequestFilter.java:117"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:189"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ApplicationFilterChain.java:162"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.StandardWrapperValve.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("StandardWrapperValve.java:197"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.StandardContextValve.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("StandardContextValve.java:97"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("AuthenticatorBase.java:541"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.StandardHostValve.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("StandardHostValve.java:135"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.valves.ErrorReportValve.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ErrorReportValve.java:92"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.core.StandardEngineValve.invoke"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("StandardEngineValve.java:78"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.catalina.connector.CoyoteAdapter.service"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("CoyoteAdapter.java:360"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.coyote.http11.Http11Processor.service"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("Http11Processor.java:399"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.coyote.AbstractProcessorLight.process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("AbstractProcessorLight.java:65"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.coyote.AbstractProtocol"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$ConnectionHandler")]),a._v(".process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("AbstractProtocol.java:893"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.tomcat.util.net.NioEndpoint"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$SocketProcessor")]),a._v(".doRun"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NioEndpoint.java:1789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.tomcat.util.net.SocketProcessorBase.run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("SocketProcessorBase.java:49"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ThreadPoolExecutor.java:1191"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.tomcat.util.threads.ThreadPoolExecutor"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$Worker")]),a._v(".run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ThreadPoolExecutor.java:659"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at org.apache.tomcat.util.threads.TaskThread"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$WrappingRunnable")]),a._v(".run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("TaskThread.java:61"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n        at java.lang.Thread.run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("Thread.java:750"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br"),t("span",{staticClass:"line-number"},[a._v("23")]),t("br"),t("span",{staticClass:"line-number"},[a._v("24")]),t("br"),t("span",{staticClass:"line-number"},[a._v("25")]),t("br"),t("span",{staticClass:"line-number"},[a._v("26")]),t("br"),t("span",{staticClass:"line-number"},[a._v("27")]),t("br"),t("span",{staticClass:"line-number"},[a._v("28")]),t("br"),t("span",{staticClass:"line-number"},[a._v("29")]),t("br"),t("span",{staticClass:"line-number"},[a._v("30")]),t("br"),t("span",{staticClass:"line-number"},[a._v("31")]),t("br"),t("span",{staticClass:"line-number"},[a._v("32")]),t("br"),t("span",{staticClass:"line-number"},[a._v("33")]),t("br"),t("span",{staticClass:"line-number"},[a._v("34")]),t("br"),t("span",{staticClass:"line-number"},[a._v("35")]),t("br"),t("span",{staticClass:"line-number"},[a._v("36")]),t("br"),t("span",{staticClass:"line-number"},[a._v("37")]),t("br"),t("span",{staticClass:"line-number"},[a._v("38")]),t("br"),t("span",{staticClass:"line-number"},[a._v("39")]),t("br"),t("span",{staticClass:"line-number"},[a._v("40")]),t("br"),t("span",{staticClass:"line-number"},[a._v("41")]),t("br"),t("span",{staticClass:"line-number"},[a._v("42")]),t("br"),t("span",{staticClass:"line-number"},[a._v("43")]),t("br"),t("span",{staticClass:"line-number"},[a._v("44")]),t("br"),t("span",{staticClass:"line-number"},[a._v("45")]),t("br"),t("span",{staticClass:"line-number"},[a._v("46")]),t("br"),t("span",{staticClass:"line-number"},[a._v("47")]),t("br"),t("span",{staticClass:"line-number"},[a._v("48")]),t("br"),t("span",{staticClass:"line-number"},[a._v("49")]),t("br"),t("span",{staticClass:"line-number"},[a._v("50")]),t("br"),t("span",{staticClass:"line-number"},[a._v("51")]),t("br"),t("span",{staticClass:"line-number"},[a._v("52")]),t("br"),t("span",{staticClass:"line-number"},[a._v("53")]),t("br"),t("span",{staticClass:"line-number"},[a._v("54")]),t("br"),t("span",{staticClass:"line-number"},[a._v("55")]),t("br"),t("span",{staticClass:"line-number"},[a._v("56")]),t("br"),t("span",{staticClass:"line-number"},[a._v("57")]),t("br"),t("span",{staticClass:"line-number"},[a._v("58")]),t("br"),t("span",{staticClass:"line-number"},[a._v("59")]),t("br"),t("span",{staticClass:"line-number"},[a._v("60")]),t("br"),t("span",{staticClass:"line-number"},[a._v("61")]),t("br"),t("span",{staticClass:"line-number"},[a._v("62")]),t("br")])]),t("p",[a._v("从上述arthas采集到的调用栈可以看到，由于"),t("code",[a._v("DemoController.pingPong2")]),a._v("内部调用了"),t("code",[a._v("BeanUtils.copyProperties")]),a._v("方法，此方法内部使用反射，进一步导致 new DelegatingClassLoader以及类加载，导致MetaSpace的使用量增加。业务代码中有部分同学使用此方法来进行浅拷贝，以完成DTO到VO的转换，这是导致MetaSpace随着迭代快速增加的原因。")]),a._v(" "),t("p",[a._v("类似的还有Spring内部的Jackson反序列化、Gson、FastJson库，均会导致MetaSpace的使用量增加。")]),a._v(" "),t("h2",{attrs:{id:"解决"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[a._v("#")]),a._v(" 解决")]),a._v(" "),t("p",[a._v("根据代码的不同类型，确定解决方案")]),a._v(" "),t("ol",[t("li",[a._v("短期方案：MetaSpace上限调整，比如从256M提升到384M")]),a._v(" "),t("li",[a._v("中长期方案：代码优化，降低反射的使用\n"),t("ul",[t("li",[a._v("优化浅拷贝：去除BeanUtils.copyProperties()方法使用，改造成MapStruct等方式进行浅拷贝")]),a._v(" "),t("li",[a._v("优化反序列化：随着业务持续发展，负载持续增加，考虑将部分payload的编码从JSON切换到ProtoBuf，Avro等二进制方案")]),a._v(" "),t("li",[a._v("优化深拷贝：深拷贝在此业务代码中出现比较多，但抽样部分代码CR后发现，前期因为业务快速迭代原因，在部分原本应该是只读对象的业务中出现了少量的属性修改，临时使用深拷贝解决，这种情况需要进行代码优化，保证"),t("strong",[a._v("只读对象使用引用共享")]),a._v("，而不需要大量拷贝")])])])]),a._v(" "),t("h2",{attrs:{id:"结果"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结果"}},[a._v("#")]),a._v(" 结果")]),a._v(" "),t("ol",[t("li",[a._v("增大MetaSpace空间后，观察1周，暂时没有新的FullGC或者OOM出现，元空间大小稳定在300M左右")]),a._v(" "),t("li",[a._v("代码优化是一个长期的过程，待进一步观察")])])])}),[],!1,null,null,null);t.default=e.exports}}]);